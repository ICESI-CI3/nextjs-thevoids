name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          node <<'NODE'
          const fs = require('fs');

          try {
            const reportPath = 'coverage/coverage-summary.json';
            if (!fs.existsSync(reportPath)) {
              throw new Error(`Coverage report not found at ${reportPath}`);
            }

            const coverage = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const metrics = ['lines', 'statements', 'functions', 'branches'];
            let failed = false;

            metrics.forEach(metric => {
              const pct = coverage.total[metric].pct;
              console.log(metric.charAt(0).toUpperCase() + metric.slice(1) + ' coverage: ' + pct + '%');
              if (pct < 80) {
                console.error(metric + ' coverage ' + pct + '% is below the required 80% threshold');
                failed = true;
              }
            });

            if (failed) {
              process.exit(1);
            }
            console.log('All coverage thresholds met');
          } catch (error) {
            console.error('Could not read coverage report:', error.message);
            process.exit(1);
          }
          NODE

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    env:
      NEXT_TELEMETRY_DISABLED: 1
      CI: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run E2E tests (headless)
        run: npm run test:e2e:headless

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [lint, build, unit-tests, e2e-tests]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.0
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
        run: railway up --service "${{ secrets.RAILWAY_SERVICE_ID }}"

      - name: Notify success
        run: echo "Application deployed successfully to Railway"
